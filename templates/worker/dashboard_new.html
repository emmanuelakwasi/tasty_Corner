{% extends "base.html" %}

{% block title %}Worker Dashboard - TastyCorner{% endblock %}

{% block navbar %}
<nav class="navbar worker-navbar">
    <div class="navbar-background"></div>
    <div class="navbar-pattern"></div>
    <div class="container">
        <div class="nav-brand">
            <a href="{{ url_for('worker_dashboard') }}" class="brand-link">
                <img src="{{ url_for('static', filename='images/fav.png') }}" alt="TastyCorner Logo" class="brand-icon">
                <span class="brand-text">
                    <span class="brand-main">TastyCorner</span>
                    <span class="brand-sub">Employee Portal</span>
                </span>
            </a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('worker_logout') }}" class="nav-link" onclick="return confirm('Are you sure you want to log out?');" style="color: #dc2626;">
                <span class="material-symbols-outlined" style="font-size: 1.1rem;">logout</span>
                <span>Log Out</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="worker-layout">
    <aside class="worker-sidebar">
        <div class="worker-sidebar-header">
            <img src="{{ url_for('static', filename='images/fav.png') }}" alt="TastyCorner Logo" class="worker-sidebar-logo">
            <div>
                <h2>Employee Portal</h2>
                <p>{{ employee.first_name }} {{ employee.last_name }}</p>
            </div>
        </div>
        <nav class="worker-side-nav">
            <button class="worker-nav-item active" data-section="dashboard">
                <span class="material-symbols-outlined">dashboard</span>
                <span>Dashboard</span>
            </button>
            <button class="worker-nav-item" data-section="attendance">
                <span class="material-symbols-outlined">schedule</span>
                <span>Attendance</span>
            </button>
            <button class="worker-nav-item" data-section="schedule">
                <span class="material-symbols-outlined">calendar_today</span>
                <span>Schedule</span>
            </button>
            <button class="worker-nav-item" data-section="payroll">
                <span class="material-symbols-outlined">payments</span>
                <span>Payroll</span>
            </button>
            <button class="worker-nav-item" data-section="profile">
                <span class="material-symbols-outlined">person</span>
                <span>Profile</span>
            </button>
        </nav>
        <div class="worker-sidebar-footer">
            <div class="worker-credentials">
                <span class="worker-label">Employee ID</span>
                <strong>{{ employee.employee_id }}</strong>
            </div>
            <a href="{{ url_for('worker_logout') }}" class="btn btn-secondary btn-sm">Sign Out</a>
        </div>
    </aside>

    <div class="worker-content" data-initial-section="dashboard">
        <header class="worker-page-header">
            <div>
                <h1>Welcome back, {{ employee.first_name }}!</h1>
                <p class="worker-page-subtitle">Here's your dashboard overview</p>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section class="worker-section active" data-section="dashboard">
            <!-- Quick Stats -->
            <div class="worker-stats-grid">
                <div class="worker-stat-card">
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <span class="material-symbols-outlined">work</span>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-value">{{ employee.job_title or 'Employee' }}</div>
                        <div class="stat-card-label">Position</div>
                    </div>
                </div>
                <div class="worker-stat-card">
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <span class="material-symbols-outlined">access_time</span>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-value">{{ hours_today|format_hours }}</div>
                        <div class="stat-card-label">Hours Today</div>
                    </div>
                </div>
                <div class="worker-stat-card">
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <span class="material-symbols-outlined">schedule</span>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-value">{{ hours_week|format_hours }}</div>
                        <div class="stat-card-label">Hours This Week</div>
                    </div>
                </div>
                <div class="worker-stat-card">
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <span class="material-symbols-outlined">payments</span>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-value">${{ "%.2f"|format((payroll_info.hours_this_period or 0) * hourly_rate) }}</div>
                        <div class="stat-card-label">Current Earnings</div>
                    </div>
                </div>
            </div>

            <!-- Time Tracking Card -->
            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">access_time</span>
                    </div>
                    <h2>Time Tracking</h2>
                </div>
                <div class="card-body">
                    <div class="time-tracking-grid">
                        <div class="time-track-item">
                            <div class="time-track-label">Live Time Clock</div>
                            <div class="live-clock" id="liveClock">--:--:--</div>
                        </div>
                        <div class="time-track-item">
                            <div class="time-track-label">Hours Worked Today</div>
                            <div class="time-track-value" id="hoursToday">{{ hours_today|format_hours }}</div>
                            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem;" id="hoursTodayDecimal">({{ "%.2f"|format(hours_today) }}h)</div>
                        </div>
                        <div class="time-track-item">
                            <div class="time-track-label">Hours Worked This Week</div>
                            <div class="time-track-value" id="hoursWeek">{{ hours_week|format_hours }}</div>
                            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem;" id="hoursWeekDecimal">({{ "%.2f"|format(hours_week) }}h)</div>
                        </div>
                        <div class="time-track-item overtime-item {% if overtime_status.is_overtime_today or overtime_status.is_overtime_week %}overtime-active{% endif %}">
                            <div class="time-track-label">Overtime Status</div>
                            <div class="time-track-value overtime-value">
                                {% if overtime_status.is_overtime_today %}
                                    <span class="overtime-badge">Today: +{{ "%.2f"|format(overtime_status.overtime_today) }}h</span>
                                {% endif %}
                                {% if overtime_status.is_overtime_week %}
                                    <span class="overtime-badge">Week: +{{ "%.2f"|format(overtime_status.overtime_week) }}h</span>
                                {% endif %}
                                {% if not overtime_status.is_overtime_today and not overtime_status.is_overtime_week %}
                                    <span class="no-overtime">No Overtime</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Attendance Section -->
        <section class="worker-section hidden" data-section="attendance">
            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">schedule</span>
                    </div>
                    <h2>Attendance</h2>
                </div>
                <div class="card-body">
                    {% if has_schedule_today %}
                        {% if attendance %}
                            <div class="attendance-status">
                                {% if attendance.check_in_time %}
                                    <div class="attendance-item">
                                        <span class="attendance-label">Check In:</span>
                                        <span class="attendance-value check-in">{{ attendance.check_in_time.split(' ')[1] if attendance.check_in_time else 'Not checked in' }}</span>
                                    </div>
                                {% endif %}
                                {% if attendance.check_out_time %}
                                    <div class="attendance-item">
                                        <span class="attendance-label">Check Out:</span>
                                        <span class="attendance-value check-out">{{ attendance.check_out_time.split(' ')[1] if attendance.check_out_time else 'Not checked out' }}</span>
                                    </div>
                                    <div class="attendance-item">
                                        <span class="attendance-label">Hours Worked:</span>
                                        <span class="attendance-value hours">{{ "%.2f"|format(attendance.hours_worked) }} hours</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="attendance-actions">
                                {% if not attendance.check_in_time %}
                                    <form method="POST" action="{{ url_for('worker_checkin') }}" style="display: inline;">
                                        <button type="submit" class="btn btn-primary btn-checkin" id="checkinBtn">
                                            <span class="material-symbols-outlined">login</span>
                                            Check In
                                        </button>
                                    </form>
                                {% elif not attendance.check_out_time %}
                                    <form method="POST" action="{{ url_for('worker_checkout') }}" style="display: inline;">
                                        <button type="submit" class="btn btn-secondary btn-checkout">
                                            <span class="material-symbols-outlined">logout</span>
                                            Check Out
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="attendance-complete">
                                        <span class="material-symbols-outlined" style="font-size: 2rem; color: #10b981; margin-bottom: 0.75rem;">check_circle</span>
                                        <p style="font-size: 0.95rem; font-weight: 600; color: #059669;">You have completed your attendance for today.</p>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="attendance-status">
                                <p>No attendance record for today. Click Check In to start.</p>
                            </div>
                            <div class="attendance-actions">
                                <form method="POST" action="{{ url_for('worker_checkin') }}" style="display: inline;">
                                    <button type="submit" class="btn btn-primary btn-checkin" id="checkinBtn">
                                        <span class="material-symbols-outlined">login</span>
                                        Check In
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="no-schedule-message">
                            <div class="no-schedule-icon">
                                <span class="material-symbols-outlined">event_busy</span>
                            </div>
                            <h3>No Work Schedule</h3>
                            <p>You don't have a scheduled shift for today. Check-in is only available when you have an assigned schedule.</p>
                            <div class="no-schedule-note">
                                <p><strong>Need to work today?</strong> Please contact your administrator to request a schedule assignment.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Schedule Section with Calendar -->
        <section class="worker-section hidden" data-section="schedule">
            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">calendar_today</span>
                    </div>
                    <h2>My Schedule</h2>
                </div>
                <div class="card-body">
                    <div class="schedule-view-tabs">
                        <button class="schedule-view-tab active" data-view="weekly">Weekly View</button>
                        <button class="schedule-view-tab" data-view="monthly">Monthly View</button>
                    </div>

                    <!-- Weekly Calendar View -->
                    <div class="schedule-calendar weekly-calendar active" id="weeklyCalendar">
                        <div class="calendar-week-header">
                            <div class="calendar-day-header">Day</div>
                            <div class="calendar-day-header">Time</div>
                            <div class="calendar-day-header">Status</div>
                        </div>
                        {% set days = [
                            ('monday', 'Monday'),
                            ('tuesday', 'Tuesday'),
                            ('wednesday', 'Wednesday'),
                            ('thursday', 'Thursday'),
                            ('friday', 'Friday'),
                            ('saturday', 'Saturday'),
                            ('sunday', 'Sunday')
                        ] %}
                        {% set schedule = employee.get('schedule') or {} %}
                        {% for day_key, day_name in days %}
                            {% set day_schedule = schedule.get(day_key, {}) %}
                            {% set is_enabled = day_schedule.get('enabled') == True or day_schedule.get('enabled') == 'true' or day_schedule.get('enabled') == 1 %}
                            <div class="calendar-week-row {% if day_key == datetime.now().strftime('%A').lower() %}today-row{% endif %}">
                                <div class="calendar-day-name">{{ day_name }}</div>
                                <div class="calendar-day-time">
                                    {% if is_enabled %}
                                        <span class="schedule-time-badge">{{ day_schedule.get('start', '09:00') }} - {{ day_schedule.get('end', '17:00') }}</span>
                                    {% else %}
                                        <span class="schedule-off-badge">Off</span>
                                    {% endif %}
                                </div>
                                <div class="calendar-day-status">
                                    {% if is_enabled %}
                                        <span class="status-badge status-active">Scheduled</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">Not Scheduled</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Monthly Calendar View -->
                    <div class="schedule-calendar monthly-calendar hidden" id="monthlyCalendar">
                        <div class="calendar-month-header">
                            <button class="calendar-nav-btn" id="prevMonth">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </button>
                            <h3 id="currentMonthYear">{{ datetime.now().strftime('%B %Y') }}</h3>
                            <button class="calendar-nav-btn" id="nextMonth">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </button>
                        </div>
                        <div class="calendar-month-grid" id="monthGrid">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Payroll Section -->
        <section class="worker-section hidden" data-section="payroll">
            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">payments</span>
                    </div>
                    <h2>Payroll Information</h2>
                </div>
                <div class="card-body">
                    <div class="payroll-info">
                        <div class="payroll-item">
                            <span class="payroll-label">Your Hourly Rate:</span>
                            <span class="payroll-value rate-value" style="font-weight: 700; color: #3b82f6;">${{ "%.2f"|format(hourly_rate) }}/hour</span>
                            {% if employee.hourly_rate %}
                                <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;">Individual Rate</div>
                            {% elif employee.job_title %}
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">Based on your role: {{ employee.job_title }}</div>
                            {% else %}
                                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">Default Rate</div>
                            {% endif %}
                        </div>
                        <div class="payroll-item">
                            <span class="payroll-label">Hours This Period:</span>
                            <span class="payroll-value hours-value" style="font-weight: 700; color: #1e293b;">{{ (payroll_info.hours_this_period or 0)|format_hours }}</span>
                            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                                ({{ "%.2f"|format(payroll_info.hours_this_period or 0) }} hours)
                            </div>
                        </div>
                        <div class="payroll-item earnings-item" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.12) 100%); border-radius: 12px; padding: 1.25rem; border: 2px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span class="payroll-label" style="font-weight: 700; color: #1e293b;">Current Earnings:</span>
                                <span class="payroll-value earnings-value" style="font-size: 1.5rem; font-weight: 800; color: #10b981;">${{ "%.2f"|format((payroll_info.hours_this_period or 0) * hourly_rate) }}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #475569; line-height: 1.6; padding: 0.75rem; background: rgba(255, 255, 255, 0.6); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <div style="margin-bottom: 0.5rem;">
                                    <strong style="color: #1e40af;">Calculation:</strong>
                                </div>
                                <div style="font-family: 'Courier New', monospace; color: #1e293b;">
                                    {{ "%.2f"|format(payroll_info.hours_this_period or 0) }} hours Ã— ${{ "%.2f"|format(hourly_rate) }}/hour = ${{ "%.2f"|format((payroll_info.hours_this_period or 0) * hourly_rate) }}
                                </div>
                                <div style="margin-top: 0.75rem; font-size: 0.8rem; color: #64748b; font-style: italic;">
                                    This is your total earnings for the current pay period (since your last payment). Hours accumulate each time you check out after working.
                                </div>
                            </div>
                        </div>
                        <div class="payroll-item">
                            <span class="payroll-label">Last Paid Date:</span>
                            <span class="payroll-value">
                                {% if payroll_info.last_paid_date %}
                                    {{ payroll_info.last_paid_date }}
                                {% else %}
                                    <span class="never-paid-text">Not paid yet</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="payroll-note">
                            <p>You are paid every 2 weeks based on hours worked. When marked as paid, your hours will reset to 0.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section class="worker-section hidden" data-section="profile">
            <!-- Profile Picture Upload Card -->
            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">photo_camera</span>
                    </div>
                    <h2>Profile Picture</h2>
                </div>
                <div class="card-body">
                    <div class="profile-picture-upload">
                        <div class="profile-picture-preview">
                            {% if employee.profile_picture %}
                                <img src="{{ url_for('static', filename='images/' + employee.profile_picture) }}" alt="Profile Picture" id="profilePreview" onerror="this.style.display='none'; document.getElementById('profilePlaceholder').style.display='flex';">
                                <div class="profile-picture-placeholder" id="profilePlaceholder" style="display: none;">
                                    <span class="material-symbols-outlined">person</span>
                                </div>
                            {% else %}
                                <div class="profile-picture-placeholder" id="profilePlaceholder">
                                    <span class="material-symbols-outlined">person</span>
                                </div>
                            {% endif %}
                        </div>
                        <form method="POST" action="{{ url_for('worker_upload_profile_picture') }}" enctype="multipart/form-data" class="profile-picture-form">
                            <input type="file" name="profile_picture" id="profilePictureInput" accept="image/*" style="display: none;" onchange="previewProfilePicture(this)">
                            <label for="profilePictureInput" class="btn btn-primary">
                                <span class="material-symbols-outlined">upload</span>
                                Upload Profile Picture
                            </label>
                            <button type="submit" class="btn btn-secondary" id="saveProfilePicture" style="display: none;">
                                <span class="material-symbols-outlined">save</span>
                                Save Picture
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="worker-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon">
                        <span class="material-symbols-outlined">person</span>
                    </div>
                    <h2>Employee Profile</h2>
                </div>
                <div class="card-body">
                    <div class="profile-info-grid">
                        <div class="info-item">
                            <span class="info-label">Employee ID</span>
                            <span class="info-value">{{ employee.employee_id }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Full Name</span>
                            <span class="info-value">{{ employee.first_name }} {{ employee.last_name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Job Title</span>
                            <span class="info-value">{{ employee.job_title or 'Not assigned' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">{{ employee.email }}</span>
                        </div>
                        {% if employee.mobile %}
                        <div class="info-item">
                            <span class="info-label">Mobile</span>
                            <span class="info-value">{{ employee.mobile }}</span>
                        </div>
                        {% endif %}
                        {% if employee.gender %}
                        <div class="info-item">
                            <span class="info-label">Gender</span>
                            <span class="info-value">{{ employee.gender }}</span>
                        </div>
                        {% endif %}
                        {% if employee.dob %}
                        <div class="info-item">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value">{{ employee.dob }}</span>
                        </div>
                        {% endif %}
                        {% if employee.address %}
                        <div class="info-item full-width">
                            <span class="info-label">Address</span>
                            <span class="info-value">{{ employee.address }}</span>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <span class="info-label">Status</span>
                            <span class="info-value status-badge status-{{ employee.status }}">
                                {{ employee.status|title }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joined</span>
                            <span class="info-value">{{ employee.created_at }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logout Card -->
            <div class="worker-card logout-card">
                <div class="card-header modern-card-header">
                    <div class="card-header-icon" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                        <span class="material-symbols-outlined">logout</span>
                    </div>
                    <h2>Account Actions</h2>
                </div>
                <div class="card-body">
                    <div class="logout-section">
                        <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">Sign out of your employee account. You'll need to log in again to access your dashboard.</p>
                        <a href="{{ url_for('worker_logout') }}" class="btn btn-danger btn-large" onclick="return confirm('Are you sure you want to log out?');" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span class="material-symbols-outlined">logout</span>
                            <span>Log Out</span>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Schedule data for calendar
    const scheduleData = {{ (employee.get('schedule') or {})|tojson }};
    const currentDate = new Date('{{ datetime.now().strftime("%Y-%m-%d") }}');
    
    // Section navigation
    (function() {
        'use strict';
        
        function initNavigation() {
            const navItems = document.querySelectorAll('.worker-nav-item');
            const sections = document.querySelectorAll('.worker-section');

            function showSection(sectionName) {
                sections.forEach((section) => {
                    section.classList.toggle('active', section.dataset.section === sectionName);
                    section.classList.toggle('hidden', section.dataset.section !== sectionName);
                });
                navItems.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.section === sectionName);
                });
            }

            navItems.forEach((item) => {
                item.addEventListener('click', function() {
                    const sectionName = this.dataset.section;
                    showSection(sectionName);
                    
                    // Initialize calendar if schedule section
                    if (sectionName === 'schedule') {
                        initMonthlyCalendar();
                    }
                });
            });

            // Show initial section
            const initialSection = document.querySelector('.worker-content').dataset.initialSection || 'dashboard';
            showSection(initialSection);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNavigation);
        } else {
            initNavigation();
        }
    })();

    // Schedule view tabs (Weekly/Monthly)
    (function() {
        'use strict';
        
        function initScheduleTabs() {
            const tabs = document.querySelectorAll('.schedule-view-tab');
            const weeklyView = document.getElementById('weeklyCalendar');
            const monthlyView = document.getElementById('monthlyCalendar');

            tabs.forEach((tab) => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const view = this.dataset.view;
                    if (view === 'weekly') {
                        weeklyView.classList.add('active');
                        weeklyView.classList.remove('hidden');
                        monthlyView.classList.add('hidden');
                        monthlyView.classList.remove('active');
                    } else {
                        monthlyView.classList.add('active');
                        monthlyView.classList.remove('hidden');
                        weeklyView.classList.add('hidden');
                        weeklyView.classList.remove('active');
                        initMonthlyCalendar();
                    }
                });
            });
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initScheduleTabs);
        } else {
            initScheduleTabs();
        }
    })();

    // Monthly Calendar Generation
    function initMonthlyCalendar() {
        const monthGrid = document.getElementById('monthGrid');
        if (!monthGrid) return;
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const fullDayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        let html = '<div class="calendar-weekdays">';
        dayNames.forEach(day => {
            html += `<div class="calendar-weekday">${day}</div>`;
        });
        html += '</div>';
        
        html += '<div class="calendar-days">';
        
        // Empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
        
        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayOfWeek = fullDayNames[date.getDay()];
            const daySchedule = scheduleData[dayOfWeek] || {};
            const isEnabled = daySchedule.enabled === true || daySchedule.enabled === 'true' || daySchedule.enabled === 1;
            const isToday = day === now.getDate() && month === now.getMonth() && year === now.getFullYear();
            
            html += `<div class="calendar-day ${isToday ? 'today' : ''} ${isEnabled ? 'scheduled' : 'not-scheduled'}">`;
            html += `<div class="calendar-day-number">${day}</div>`;
            if (isEnabled) {
                html += `<div class="calendar-day-schedule">${daySchedule.start || '09:00'} - ${daySchedule.end || '17:00'}</div>`;
            } else {
                html += `<div class="calendar-day-schedule off">Off</div>`;
            }
            html += '</div>';
        }
        
        html += '</div>';
        monthGrid.innerHTML = html;
        
        // Update month/year display
        const monthYearEl = document.getElementById('currentMonthYear');
        if (monthYearEl) {
            monthYearEl.textContent = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
    }

    // Month navigation
    document.getElementById('prevMonth')?.addEventListener('click', function() {
        // TODO: Implement month navigation
        console.log('Previous month');
    });

    document.getElementById('nextMonth')?.addEventListener('click', function() {
        // TODO: Implement month navigation
        console.log('Next month');
    });

    // Live Time Clock
    function updateLiveClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const clockElement = document.getElementById('liveClock');
        if (clockElement) {
            clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
    }

    // Format hours helper function
    function formatHours(hours) {
        if (hours === 0) return "0 hours";
        const wholeHours = Math.floor(hours);
        const minutes = Math.floor((hours - wholeHours) * 60);
        if (wholeHours === 0) {
            return minutes + (minutes === 1 ? " minute" : " minutes");
        } else if (minutes === 0) {
            return wholeHours + (wholeHours === 1 ? " hour" : " hours");
        } else {
            return wholeHours + "h " + minutes + "m";
        }
    }

    // Update hours worked today if checked in
    function updateHoursToday() {
        {% if attendance and attendance.check_in_time and not attendance.check_out_time %}
        const checkInTime = new Date('{{ attendance.check_in_time }}');
        const now = new Date();
        const hours = (now - checkInTime) / (1000 * 60 * 60);
        const hoursElement = document.getElementById('hoursToday');
        const hoursDecimalElement = document.getElementById('hoursTodayDecimal');
        if (hoursElement) {
            hoursElement.textContent = formatHours(hours);
        }
        if (hoursDecimalElement) {
            hoursDecimalElement.textContent = '(' + hours.toFixed(2) + 'h)';
        }
        {% endif %}
    }

    // Initialize clock and hours updates
    updateLiveClock();
    updateHoursToday();
    setInterval(updateLiveClock, 1000);
    {% if attendance and attendance.check_in_time and not attendance.check_out_time %}
    setInterval(updateHoursToday, 60000); // Update every minute
    {% endif %}

    // Profile picture preview
    function previewProfilePicture(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('profilePreview');
                const placeholder = document.getElementById('profilePlaceholder');
                const saveButton = document.getElementById('saveProfilePicture');
                
                if (!preview) {
                    const img = document.createElement('img');
                    img.id = 'profilePreview';
                    img.src = e.target.result;
                    img.alt = 'Profile Picture';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '50%';
                    placeholder.parentNode.insertBefore(img, placeholder);
                    placeholder.style.display = 'none';
                } else {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                }
                
                if (saveButton) {
                    saveButton.style.display = 'inline-flex';
                }
            };
            reader.readAsDataURL(file);
        }
    }

    // Check-in time validation
    document.getElementById('checkinBtn')?.addEventListener('click', function(e) {
        {% if has_schedule_today %}
        const todaySchedule = scheduleData['{{ datetime.now().strftime("%A").lower() }}'] || {};
        if (todaySchedule.enabled) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes(); // minutes since midnight
            
            const startTime = todaySchedule.start || '09:00';
            const endTime = todaySchedule.end || '17:00';
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const scheduleStart = startHour * 60 + startMin;
            const scheduleEnd = endHour * 60 + endMin;
            
            // Allow check-in 15 minutes before scheduled time
            const checkInWindowStart = scheduleStart - 15;
            const checkInWindowEnd = scheduleEnd;
            
            if (currentTime < checkInWindowStart) {
                e.preventDefault();
                alert(`You can only check in 15 minutes before your scheduled time (${startTime}). Your schedule starts at ${startTime}.`);
                return false;
            }
            
            if (currentTime > checkInWindowEnd) {
                e.preventDefault();
                alert(`Your scheduled time has ended (${endTime}). Please contact your administrator if you need to check in.`);
                return false;
            }
        }
        {% endif %}
    });
</script>
{% endblock %}

